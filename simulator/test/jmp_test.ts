import * as nodeunit        from 'nodeunit';
import * as memory          from "../ArchV/memory";
import * as processor       from "../ArchV/processor";

export var addrTest: nodeunit.ITestGroup = {
    
    setUp: (callback) => {
        this.cpu = new processor.CPU();
        this.mem = memory.create(1024*10); // 10kb
        this.sys = new processor.System(this.cpu, this.mem);
        
        callback();
    },
    
    tearDown: (callback) => {
        this.sys.reboot();
        
        callback();
    },
    
    testSimpleJmp: (test: nodeunit.Test) => {
        test.expect(4);
        
        var program = [
            /* 0x00001000 */ 0x0b, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00, // jmp *0x00001010 
            /* 0x00001008 */ 0x04, 0x99, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 99, gp1
            /* 0x00001010 */ 0x04, 0x33, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 33, gp2
            /* 0x00001018 */ 0x0b, 0x00, 0x00, 0x10, 0x28, 0x00, 0x00, 0x00, // jmp *0x00001028
            /* 0x00001020 */ 0x04, 0x99, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 99, gp4 
            /* 0x00001028 */ 0x04, 0x44, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 44, gp3
            /* 0x00001030 */ 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // hlt 
        ];
        
        this.sys.boot(program, 0x1000);

        test.equal(this.cpu.gp1, 0x00);
        test.equal(this.cpu.gp2, 0x33);
        test.equal(this.cpu.gp3, 0x44);
        test.equal(this.cpu.gp4, 0x00);

        test.done();
    },
    
    testSimpleJnz: (test: nodeunit.Test) => {
        test.expect(3);
        
        var program = [
            /* 0x00001000 */ 0x04, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 0, zf 
            /* 0x00001008 */ 0x0c, 0x00, 0x00, 0x10, 0x18, 0x00, 0x00, 0x00, // jnz *0x00001018
            /* 0x00001010 */ 0x04, 0x99, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 99, gp1
            /* 0x00001018 */ 0x04, 0x33, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 33, gp2
            /* 0x00001020 */ 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // hlt 
        ];
        
        this.sys.boot(program, 0x1000);

        test.equal(this.cpu.zf, 0x00);
        test.equal(this.cpu.gp1, 0x00);
        test.equal(this.cpu.gp2, 0x33);

        test.done();
    },
    
    testSimpleJz: (test: nodeunit.Test) => {
        test.expect(3);
        
        var program = [
            /* 0x00001000 */ 0x04, 0x01, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 1, zf
            /* 0x00001008 */ 0x0d, 0x00, 0x00, 0x10, 0x18, 0x00, 0x00, 0x00, // jz *0x00001018
            /* 0x00001010 */ 0x04, 0x99, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 99, gp1
            /* 0x00001018 */ 0x04, 0x33, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, // movr8 33, gp2 
            /* 0x00001020 */ 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // hlt
        ];
        
        this.sys.boot(program, 0x1000);

        test.equal(this.cpu.zf, 0x01);
        test.equal(this.cpu.gp1, 0x00);
        test.equal(this.cpu.gp2, 0x33);
        
        test.done(); 
    }
};